<% if (theme.home_banner.style === "fixed") { %>
    <style>
        .home-banner-container {
            background: none !important;
        }
        .home-article-item,
        .sidebar-links,
        .sidebar-content,
        a.page-number,
        a.extend,
        .sidebar-links .links:hover,
        .right-bottom-tools,
        footer.footer {
            background-color: var(--background-color-transparent-80) !important;
        }
        .right-bottom-tools:hover,
        a.page-number:hover,
        a.extend:hover {
            background-color: var(--primary-color) !important;
        }
        .site-info,
        .home-article-sticky-label {
            background-color: var(--background-color-transparent-15) !important;
        }
        .home-article-sticky-label {
            backdrop-filter: none !important;
        }
    </style>
    <div class="home-banner-background transition-fade fixed top-0 left-0 w-screen h-screen scale-125 sm:scale-110 box-border will-change-transform bg-cover">
        <img src="<%- url_for(theme.home_banner.image.light) %>" alt="home-banner-background" class="w-full h-full object-cover dark:hidden">
        <img src="<%- url_for(theme.home_banner.image.dark) %>" alt="home-banner-background" class="w-full h-full object-cover hidden dark:block">
    </div>
<% } %>

<div class="home-banner-container flex justify-center items-center transition-fade relative">
    <% if (theme.home_banner.style !== "fixed") {%>
    <div class="home-banner-background transition-fade absolute top-0 left-0 w-screen h-screen scale-125 sm:scale-110 box-border will-change-transform bg-cover">
        <img src="<%- url_for(theme.home_banner.image.light) %>" alt="home-banner-background" class="w-full h-full object-cover dark:hidden">
        <img src="<%- url_for(theme.home_banner.image.dark) %>" alt="home-banner-background" class="w-full h-full object-cover hidden dark:block">
    </div>
    <% } %>
    <div class="content mt-8 flex flex-col justify-center items-center transition-fade-down">
        <div class="description flex flex-col justify-center items-center w-screen font-medium text-center"
        <% if (theme.home_banner.custom_font.enable) { %>
             style="font-family: '<%- theme.home_banner.custom_font.family %>', sans-serif; !important;"
                <% } %>
        >
            <%- theme.home_banner.title || theme.style.first_screen.description || config.description %>
            <%# theme.style.first_screen.description is deprecated %>
            <% const subtitleConfig = theme.home_banner.subtitle || {}; %>
            <% const subtitleText = subtitleConfig.text; %>
            <% const subtitleEntries = Array.isArray(subtitleText)
                ? subtitleText
                : subtitleText
                    ? [subtitleText]
                    : []; %>
            <% if (subtitleEntries.length !== 0 || (subtitleConfig.hitokoto && subtitleConfig.hitokoto.enable)) { %>
                <p><i id="subtitle"></i></p>
            <% } %>
        </div>
        <% if (theme.home_banner.social_links.enable) { %>
            <%
                const flexDirection = theme.home_banner.social_links.style === "reverse" ? "flex-row-reverse" : "flex-row";
                const justify = theme.home_banner.social_links.style === "center" ? "justify-center" : "justify-between";
                const display = theme.home_banner.social_links.style === "center" ? "hidden" : "flex";
                const socialLinks = theme.home_banner.social_links || {};
                const links = Array.isArray(socialLinks.links) ? socialLinks.links : [];
                const qrs = Array.isArray(socialLinks.qrs) ? socialLinks.qrs : [];
                const hasQrs = qrs.some((item) => item && item.qr);
                const normalizeIcon = (iconValue, fallbackName) => {
                    const source = iconValue || fallbackName || "";
                    if (!source) {
                        return "";
                    }
                    if (source === "email") {
                        return "fa-solid fa-at";
                    }
                    if (source.startsWith('/') || source.startsWith('http')) {
                        return source;
                    }
                    if (source.includes('fa-')) {
                        return source;
                    }
                    return `fa-brands fa-${source}`;
                };
            %>
            <div class="absolute bottom-0.5 flex <%- flexDirection %> <%- justify %> max-w-[1340px] items-center w-full px-8 sm:px-12">
                <div class="<%- display %> p-3 bg-gray-300/50 dark:bg-gray-500/40 backdrop-blur-lg border border-white/20 dark:border-gray-500/30 group rounded-full cursor-pointer flex justify-center items-center aspect-square h-full shadow-redefine-flat hover:shadow-redefine-flat-hover transition-shadow" onclick="scrollToMain()" >
                    <i class="fa-solid fa-arrow-down fa-fw fa-lg group-hover:translate-y-1 transition-transform"></i>
                </div>
                <div class="social-contacts px-6 py-3 bg-gray-300/50 dark:bg-gray-500/40 backdrop-blur-lg border border-white/20 dark:border-gray-500/30 shadow-redefine-flat rounded-full flex flex-row gap-3 items-center">
                    <% for (const item of links) { %>
                        <% if (item && item.url) { %>
                            <% const name = item.name || ""; %>
                            <% const icon = normalizeIcon(item.icon, name); %>
                            <% const url = item.url; %>
                            <% const isEmail = name === "email" || (icon && icon.includes("fa-at")); %>
                            <% const resolvedUrl = isEmail && !url.startsWith("mailto:") ? `mailto:${url}` : url; %>
                            <% if (isEmail) { %>
                                <% const emailIcon = icon && icon.includes("fa-") ? icon : "fa-solid fa-at"; %>
                                <span class="social-contact-item <%= name %>">
                                    <a href="<%- resolvedUrl %>">
                                        <i class="<%= emailIcon %> fa-fw fa-lg"></i>
                                    </a>
                                </span>
                            <% } else if (icon && icon.includes("fa-")) { %>
                                <span class="social-contact-item">
                                    <a target="_blank" href="<%- resolvedUrl %>">
                                        <i class="<%= icon %> fa-fw fa-lg"></i>
                                    </a>
                                </span>
                            <% } else if (icon && (icon.startsWith('/') || icon.startsWith('http'))) { %>
                                <span class="social-contact-item">
                                    <a target="_blank" href="<%- resolvedUrl %>">
                                        <img src="<%- url_for(icon) %>" alt="social-icon" class="w-5 h-5 object-contain">
                                    </a>
                                </span>
                            <% } else if (name) { %>
                                <span class="social-contact-item <%= name %>">
                                    <a target="_blank" href="<%- resolvedUrl %>">
                                        <i class="fa-brands fa-fw fa-lg fa-<%= name %>"></i>
                                    </a>
                                </span>
                            <% } %>
                        <% } %>
                    <% } %>
                    <% if (hasQrs) { %>

                        <div class="social-links-divider vertical-separator w-[1px] h-4 bg-third-text-color mx-0.5"></div>

                        <% for (const item of qrs) { %>
                            <% if (item && item.qr) { %>
                                <% const name = item.name || ""; %>
                                <% const icon = normalizeIcon(item.icon, name); %>
                                <% const qr = item.qr; %>
                                <% if (icon && icon.includes("fa-")) { %>
                                    <span class="social-contact-item-qr cursor-pointer group qr-toggle-item">
                                        <a target="_blank">
                                            <i class="<%= icon %> fa-fw fa-lg qr-trigger"></i>
                                            <div class="social-qr-container absolute h-auto bg-background-color-transparent-40 border border-white/20 dark:border-gray-500/30 overflow-hidden rounded-2xl bottom-0 mb-14 right-0 invisible group-hover:visible group-active:visible opacity-0 group-hover:opacity-100 group-active:opacity-100 translate-y-0.5 group-hover:translate-y-0 group-active:translate-y-0 transition-all qr-popup">
                                                <img class="social-contacts-qr w-64"
                                                     src="<%- url_for(qr) %>"/>
                                            </div>
                                        </a>
                                    </span>
                                <% } else if (icon && (icon.startsWith('/') || icon.startsWith('http'))) { %>
                                    <span class="social-contact-item-qr cursor-pointer group qr-toggle-item">
                                        <a target="_blank">
                                            <img src="<%- url_for(icon) %>" alt="social-icon" class="w-5 h-5 object-contain qr-trigger">
                                            <div class="social-qr-container absolute h-auto bg-background-color-transparent-40 border border-white/20 dark:border-gray-500/30 overflow-hidden rounded-2xl bottom-0 mb-14 right-0 invisible group-hover:visible group-active:visible opacity-0 group-hover:opacity-100 group-active:opacity-100 translate-y-0.5 group-hover:translate-y-0 group-active:translate-y-0 transition-all qr-popup">
                                                <img class="social-contacts-qr w-64"
                                                     src="<%- url_for(qr) %>"/>
                                            </div>
                                        </a>
                                    </span>
                                <% } else if (name) { %>
                                    <span class="social-contact-item-qr <%= name %> cursor-pointer group qr-toggle-item">
                                        <a target="_blank">
                                            <i class="fa-brands fa-fw fa-lg fa-<%= name %> qr-trigger"></i>
                                            <div class="social-qr-container absolute h-auto bg-background-color-transparent-40 border border-white/20 dark:border-gray-500/30 overflow-hidden rounded-2xl bottom-0 mb-14 right-0 invisible group-hover:visible group-active:visible opacity-0 group-hover:opacity-100 group-active:opacity-100 translate-y-0.5 group-hover:translate-y-0 group-active:translate-y-0 transition-all qr-popup">
                                                <img class="social-contacts-qr w-64"
                                                     src="<%- url_for(qr) %>"/>
                                            </div>
                                        </a>
                                    </span>
                                <% } %>
                            <% } %>
                        <% } %>
                    <% } %>
                    <% if (theme.home_banner.bg_info && theme.home_banner.bg_info.enable) { %>
                        <div class="social-links-divider vertical-separator w-[1px] h-4 bg-third-text-color mx-0.5"></div>
                        <span class="bg-info-container" id="bg-info-container">
                             <div class="text-gray-600 dark:text-gray-300">
                                <i class="<%= theme.home_banner.bg_info.icon %> fa-fw fa-lg icon"></i>
                                <div class="bg-info-popup">
                                    <div class="title" id="bg-info-title">
                                        <% if (theme.home_banner.bg_info.mode !== 'api') { %>
                                            <%= theme.home_banner.bg_info.static.title %>
                                        <% } else { %>
                                            Loading...
                                        <% } %>
                                    </div>
                                    <div class="desc" id="bg-info-desc">
                                        <% if (theme.home_banner.bg_info.mode !== 'api') { %>
                                            <%= theme.home_banner.bg_info.static.desc %>
                                        <% } else { %>
                                            Loading...
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </span>
                    <% } %>
                </div>
            </div>
        <% } %>
    </div>
    <style>
        /* Mobile-specific QR code styles */
        .qr-toggle-item.qr-active .qr-popup {
            visibility: visible !important;
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        
        /* Prevent button from staying in focus/hover state on mobile */
        @media (hover: none) and (pointer: coarse) {
            .qr-toggle-item:focus,
            .qr-toggle-item:hover {
                background-color: transparent;
            }
            
            .qr-toggle-item .qr-trigger:focus,
            .qr-toggle-item .qr-trigger:hover {
                background-color: transparent;
                color: inherit;
            }
            
            /* Only show active state when explicitly toggled */
            .qr-popup {
                visibility: hidden !important;
                opacity: 0 !important;
            }
        }
    </style>
</div>

<script>
    const scrollToMain = () => {
        const target = document.querySelector('.main-content-container');
        if (target) {
            target.scrollIntoView({ behavior: 'smooth'});
        }
    }
</script>

<script <%= theme.global.single_page === true && 'data-swup-reload-script' %>>
    // Mobile QR Toggle
    function initQrToggle() {
        const qrToggleItems = document.querySelectorAll('.qr-toggle-item');
        if (qrToggleItems.length === 0) return;

        // Handle QR code toggle for mobile
        qrToggleItems.forEach(item => {
            const trigger = item.querySelector('.qr-trigger');
            if (!trigger) return;

            // Remove existing listeners to avoid duplicates on re-run
            const newTrigger = trigger.cloneNode(true);
            trigger.parentNode.replaceChild(newTrigger, trigger);
            
            // Add click event for mobile
            newTrigger.addEventListener('click', function(e) {
                // Check if it's a touch device or small screen
                if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
                    e.preventDefault();
                    
                    // Close any other open QR codes
                    qrToggleItems.forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.classList.remove('qr-active');
                        }
                    });

                    // Toggle current QR code
                    item.classList.toggle('qr-active');
                }
            });
        });
        
        // Close QR code when clicking outside
        document.addEventListener('click', function(e) {
            if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
                if (!e.target.closest('.qr-toggle-item')) {
                    qrToggleItems.forEach(item => {
                        item.classList.remove('qr-active');
                    });
                }
            }
        });
    }

    // BgInfo Init
    function initBgInfo() {
        const bgInfoConfig = <%- JSON.stringify(theme.home_banner.bg_info) %>;
        
        // Exit if bg_info is disabled or not in api mode
        if (!bgInfoConfig || !bgInfoConfig.enable || bgInfoConfig.mode !== 'api') {
            return;
        }

        const titleElement = document.getElementById('bg-info-title');
        const descElement = document.getElementById('bg-info-desc');
        
        // If elements don't exist (e.g. not on home page), return
        if (!titleElement || !descElement) {
            return;
        }

        const apiUrl = bgInfoConfig.api.url;
        const titleField = bgInfoConfig.api.response_fields.title;
        const descField = bgInfoConfig.api.response_fields.desc;

        // Check session storage first
        const cachedData = sessionStorage.getItem('bg_info_data');
        if (cachedData) {
            try {
                const data = JSON.parse(cachedData);
                if (data[titleField]) titleElement.textContent = data[titleField];
                if (data[descField]) descElement.textContent = data[descField];
                return;
            } catch (e) {
                console.error('Error parsing cached bg_info data', e);
                sessionStorage.removeItem('bg_info_data');
            }
        }

        // Fetch from API
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data[titleField]) {
                    titleElement.textContent = data[titleField];
                }
                
                if (data[descField]) {
                    descElement.textContent = data[descField];
                }

                // Cache the data
                sessionStorage.setItem('bg_info_data', JSON.stringify(data));
            })
            .catch(error => {
                console.error('Error fetching background info:', error);
                if (titleElement) titleElement.textContent = 'Error';
                if (descElement) descElement.textContent = 'Failed to load info';
            });
    }
    
    // Initialize
    initQrToggle();
    initBgInfo();
</script>
